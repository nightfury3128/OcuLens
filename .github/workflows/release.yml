name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        python release_builder.py
    
    - name: Upload executable as artifact
      uses: actions/upload-artifact@v3
      with:
        name: iPhone-Webcam-Windows
        path: |
          release/iPhone-Webcam.exe
          release/QUICK_START.txt
          release/README.md
          release/LICENSE
    
    - name: Upload ZIP package as artifact
      uses: actions/upload-artifact@v3
      with:
        name: iPhone-Webcam-Release-Package
        path: iPhone-Webcam-Release.zip
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          iPhone-Webcam-Release.zip
          release/iPhone-Webcam.exe
        body: |
          ## üì± iPhone Webcam v${{ github.ref_name }}
          
          ### üöÄ Quick Start
          1. Download `iPhone-Webcam.exe` 
          2. Double-click to run (Windows may show security warning - click "More info" then "Run anyway")
          3. Scan the QR code with your iPhone camera
          4. Your iPhone is now a webcam!
          
          ### üì• Download Options
          - **Single File**: `iPhone-Webcam.exe` - Just download and run
          - **Complete Package**: `iPhone-Webcam-Release.zip` - Includes documentation and quick start guide
          
          ### ‚ú® Features
          - üé• Turn your iPhone into a wireless webcam
          - üîÑ Works with Zoom, Teams, OBS, and any video app
          - üì± QR code for instant connection
          - üéØ Zero configuration required
          - üñ•Ô∏è System tray integration
          - üìä Real-time performance monitoring
          
          ### üõ†Ô∏è Requirements
          - Windows 10/11
          - iPhone with Safari browser
          - Same WiFi network for both devices
          
          ### üÜò Support
          Having issues? Check our [troubleshooting guide](https://github.com/nightfury3128/iphoneWebCam#troubleshooting) or [open an issue](https://github.com/nightfury3128/iphoneWebCam/issues).
          
          ---
          
          **File Checksums:**
          - See the Assets section below for SHA256 hashes
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS executable
      run: |
        pyinstaller --onefile --name=iPhone-Webcam-macOS \
          --add-data="iphone.html:." \
          --add-data="cert.pem:." \
          --add-data="key.pem:." \
          --hidden-import=cv2 \
          --hidden-import=numpy \
          --hidden-import=flask \
          --hidden-import=pyvirtualcam \
          --hidden-import=qrcode \
          --hidden-import=PIL \
          --hidden-import=OpenSSL \
          --hidden-import=websockets \
          --hidden-import=pystray \
          main.py
    
    - name: Upload macOS executable
      uses: actions/upload-artifact@v3
      with:
        name: iPhone-Webcam-macOS
        path: dist/iPhone-Webcam-macOS
    
    - name: Upload to Release (macOS)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/iPhone-Webcam-macOS
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev python3-setuptools
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Linux executable
      run: |
        pyinstaller --onefile --name=iPhone-Webcam-Linux \
          --add-data="iphone.html:." \
          --add-data="cert.pem:." \
          --add-data="key.pem:." \
          --hidden-import=cv2 \
          --hidden-import=numpy \
          --hidden-import=flask \
          --hidden-import=pyvirtualcam \
          --hidden-import=qrcode \
          --hidden-import=PIL \
          --hidden-import=OpenSSL \
          --hidden-import=websockets \
          --hidden-import=pystray \
          main.py
    
    - name: Upload Linux executable
      uses: actions/upload-artifact@v3
      with:
        name: iPhone-Webcam-Linux
        path: dist/iPhone-Webcam-Linux
    
    - name: Upload to Release (Linux)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/iPhone-Webcam-Linux
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}